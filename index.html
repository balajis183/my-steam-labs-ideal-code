<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Blockly Code Generator</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="./custom_blocks.js"></script>
    <link rel="stylesheet" href="./style.css" />

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        font-family: sans-serif;
      }

      #navbar-placeholder {
        width: 100%;
      }

      #topbar {
        padding: 10px;
        background: #f0f0f0;
        border-bottom: 1px solid #ccc;
        width: 100%;
        box-sizing: border-box;
      }

      #main-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: calc(100vh - 50px); /* fallback, updated dynamically */
      }

      #main {
        display: flex;
        width: 100%;
        flex: 1;
        min-height: 0;
      }

      #blocklyDiv {
        height: 100%;
        width: 70%;
        position: relative;
        background: #fff;
      }

      #codeArea {
        width: 30%;
        height: 100%;
        padding: 10px;
        background: #fafafa;
        border-left: 1px solid #ccc;
        box-sizing: border-box;
      }

      /* Terminal Panel Styles */
      #terminal-panel {
        background: #1e1e1e;
        color: #f0f0f0;
        border-top: 1px solid #333;
        display: none; /* Hidden by default */
        flex-direction: column;
        min-height: 200px;
        max-height: 50vh;
      }

      #terminal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #2d2d2d;
        border-bottom: 1px solid #444;
        font-size: 12px;
        font-weight: 500;
      }

      #terminal-title {
        color: #ccc;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      #terminal-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .terminal-btn {
        background: #444;
        color: #fff;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 10px;
        transition: background 0.2s;
      }

      .terminal-btn:hover {
        background: #555;
      }

      #terminal-resize-handle {
        height: 4px;
        background: #444;
        cursor: ns-resize;
        transition: background 0.2s;
      }

      #terminal-resize-handle:hover {
        background: #666;
      }

      #terminal-content {
        flex: 1;
        padding: 12px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        overflow-y: auto;
        background: #1e1e1e;
      }

      #terminal-output {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.4;
      }

      /* Terminal toggle button */
      #terminal-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #007acc;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }

      #terminal-toggle:hover {
        background: #005a9e;
      }

      button {
        margin-right: 10px;
        padding: 6px 12px;
        cursor: pointer;
      }

      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
    </style>
  </head>

  <body>
    <!-- Navbar loaded dynamically -->
    <div id="navbar-placeholder"></div>

    <!-- Toolbar -->
    <div id="topbar">
      <button onclick="generateJavaScriptCode()">Generate JavaScript</button>
      <button onclick="generatePythonCode()">Generate Python</button>
      <button onclick="generateCppCode()">Generate C++</button>
      <button onclick="generateCCode()">Generate C</button>
      <button onclick="copyCode()">Copy Code</button>
      <button onclick="saveCode()">Save Code</button>
      <button onclick="loadCode()">Load Code</button>
      <button id="checkConnectionBtn">Check Board Status</button>
      <div id="connection-status" style="width:15px; height:15px; border-radius:50%; background-color:grey; display:inline-block; margin-left:10px;"></div>
    </div>

    <!-- Main container with terminal -->
    <div id="main-container">
      <!-- Main layout -->
      <div id="main">
        <div id="blocklyDiv"></div>
        <div id="codeArea">
          <iframe id="monacoEditor" src="monaco.html"></iframe>
        </div>
      </div>

      <!-- Terminal Panel -->
      <div id="terminal-panel">
        <div id="terminal-header">
          <span id="terminal-title">Terminal</span>
          <div id="terminal-controls">
            <button class="terminal-btn" onclick="clearTerminal()">Clear</button>
            <button class="terminal-btn" onclick="toggleTerminal()">Hide</button>
          </div>
        </div>
        <div id="terminal-resize-handle"></div>
        <div id="terminal-content">
          <pre id="terminal-output"></pre>
        </div>
      </div>
    </div>

    <!-- Terminal Toggle Button -->
    <button id="terminal-toggle" onclick="toggleTerminal()" title="New: Compile now auto-opens the terminal.">Show Terminal</button>

    <!-- Blockly Toolbox -->
    <xml id="toolbox" style="display: none">
      <category name="Logic" colour="210">
        <block type="controls_if"></block>
        <block type="enhanced_if"></block>
        <block type="logic_compare"></block>
        <block type="enhanced_compare"></block>
        <block type="logic_operation"></block>
        <block type="enhanced_logic"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
      </category>
      <category name="Loops" colour="120">
        <block type="controls_repeat_ext">
          <value name="TIMES">
            <block type="math_number">
              <field name="NUM">10</field>
            </block>
          </value>
        </block>
        <block type="controls_whileUntil"></block>
      </category>
      <category name="Math" colour="230">
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
      </category>
      <category name="Pin I/O" colour="230">
        <block type="set_pin"></block>
        <block type="read_pin"></block>
      </category>
      <category name="Motors" colour="20">
        <block type="dc_motor"></block>
        <block type="servo_motor"></block>
      </category>
      <category name="Sensors" colour="120">
        <block type="ldr_sensor"></block>
        <block type="ir_sensor"></block>
        <block type="temp_sensor"></block>
        <block type="ultrasonic_sensor"></block>
        <block type="touch_sensor"></block>
        <block type="color_sensor"></block>
      </category>
      <category name="Joystick" colour="290">
        <block type="joystick1"></block>
        <block type="joystick2"></block>
      </category>
      <category name="OLED Display" colour="330">
        <block type="oled_show"></block>
      </category>
      <category name="Time" colour="195">
        <block type="time_delay">
          <value name="TIME">
            <block type="math_number">
              <field name="NUM">1000</field>
            </block>
          </value>
        </block>
      </category>
      <category name="My Program" colour="160">
        <block type="my_program"></block>
      </category>
      <category name="Text" colour="160">
        <block type="text"></block>
        <block type="text_print"></block>
      </category>
      <category name="Variables" colour="330">
        <button text="Create variable..." callbackKey="CREATE_VARIABLE"></button>
        <block type="variables_declare">
          <field name="VAR" id="variable_id_1" variabletype="">i_count</field>
        </block>
        <block type="variables_define">
          <field name="VAR" id="variable_id_1" variabletype="">i_count</field>
        </block>
        <block type="math_change">
          <field name="VAR" id="variable_id_1" variabletype="">i_count</field>
          <value name="DELTA">
            <block type="math_number">
              <field name="NUM">1</field>
            </block>
          </value>
        </block>
        <block type="variables_get">
          <field name="VAR" id="variable_id_1" variabletype="">i_count</field>
        </block>
      </category>
      <category name="Functions" colour="290" custom="PROCEDURE"></category>
    </xml>

    <script>
      let workspace;
      let terminalVisible = false;
      let isResizing = false;
      let startY = 0;
      let startHeight = 0;

      // Define custom blocks before initializing Blockly
      function defineCustomBlocks() {
        // My Program block
        Blockly.Blocks['my_program'] = {
          init: function() {
            this.appendDummyInput()
                .appendField("? My Program");
            this.appendStatementInput("PROGRAM")
                .setCheck(null);
            this.setColour(160);
            this.setTooltip("Main program block");
            this.setHelpUrl("");
          }
        };

        Blockly.JavaScript['my_program'] = function(block) {
          var statements_program = Blockly.JavaScript.statementToCode(block, 'PROGRAM');
          var code = '// My Program\n' + statements_program;
          return code;
        };

        // Time delay block
        Blockly.Blocks['time_delay'] = {
          init: function() {
            this.appendValueInput("TIME")
                .setCheck("Number")
                .appendField("Time");
            this.appendDummyInput()
                .appendField("ms");
            this.setPreviousStatement(true, null);
            this.setNextStatement(true, null);
            this.setColour(195);
            this.setTooltip("Wait for specified milliseconds");
            this.setHelpUrl("");
          }
        };

        Blockly.JavaScript['time_delay'] = function(block) {
          var value_time = Blockly.JavaScript.valueToCode(block, 'TIME', Blockly.JavaScript.ORDER_ATOMIC);
          var code = 'delay(' + value_time + ');\n';
          return code;
        };

        // Enhanced if block to match your image
        Blockly.Blocks['enhanced_if'] = {
          init: function() {
            this.appendValueInput("IF0")
                .setCheck("Boolean")
                .appendField("if");
            this.appendStatementInput("DO0")
                .setCheck(null)
                .appendField("do");
            this.setPreviousStatement(true, null);
            this.setNextStatement(true, null);
            this.setColour(210);
            this.setTooltip("If condition is true, execute statements");
            this.setHelpUrl("");
          }
        };

        Blockly.JavaScript['enhanced_if'] = function(block) {
          var value_if0 = Blockly.JavaScript.valueToCode(block, 'IF0', Blockly.JavaScript.ORDER_NONE);
          var statements_do0 = Blockly.JavaScript.statementToCode(block, 'DO0');
          var code = 'if (' + value_if0 + ') {\n' + statements_do0 + '}\n';
          return code;
        };

        // Enhanced comparison block
        Blockly.Blocks['enhanced_compare'] = {
          init: function() {
            this.appendValueInput("A")
                .setCheck(null);
            this.appendDummyInput()
                .appendField(new Blockly.FieldDropdown([["==","EQ"], ["≠","NEQ"], [">","GT"], ["<","LT"], ["≥","GTE"], ["≤","LTE"]]), "OP");
            this.appendValueInput("B")
                .setCheck(null);
            this.setInputsInline(true);
            this.setOutput(true, "Boolean");
            this.setColour(210);
            this.setTooltip("Compare two values");
            this.setHelpUrl("");
          }
        };

        Blockly.JavaScript['enhanced_compare'] = function(block) {
          var OPERATORS = {
            'EQ': '==',
            'NEQ': '!=',
            'LT': '<',
            'LTE': '<=',
            'GT': '>',
            'GTE': '>='
          };
          var operator = OPERATORS[block.getFieldValue('OP')];
          var order = (operator == '==' || operator == '!=') ?
              Blockly.JavaScript.ORDER_EQUALITY : Blockly.JavaScript.ORDER_RELATIONAL;
          var argument0 = Blockly.JavaScript.valueToCode(block, 'A', order) || '0';
          var argument1 = Blockly.JavaScript.valueToCode(block, 'B', order) || '0';
          var code = argument0 + ' ' + operator + ' ' + argument1;
          return [code, order];
        };

        // Enhanced logic operation block
        Blockly.Blocks['enhanced_logic'] = {
          init: function() {
            this.appendValueInput("A")
                .setCheck("Boolean");
            this.appendDummyInput()
                .appendField(new Blockly.FieldDropdown([["&&","AND"], ["||","OR"]]), "OP");
            this.appendValueInput("B")
                .setCheck("Boolean");
            this.setInputsInline(true);
            this.setOutput(true, "Boolean");
            this.setColour(210);
            this.setTooltip("Logic operation between two boolean values");
            this.setHelpUrl("");
          }
        };

        Blockly.JavaScript['enhanced_logic'] = function(block) {
          var operator = (block.getFieldValue('OP') == 'AND') ? '&&' : '||';
          var order = (operator == '&&') ? Blockly.JavaScript.ORDER_LOGICAL_AND :
              Blockly.JavaScript.ORDER_LOGICAL_OR;
          var argument0 = Blockly.JavaScript.valueToCode(block, 'A', order);
          var argument1 = Blockly.JavaScript.valueToCode(block, 'B', order);
          if (!argument0 && !argument1) {
            argument0 = 'false';
            argument1 = 'false';
          } else {
            var defaultArgument = (operator == '&&') ? 'true' : 'false';
            if (!argument0) {
              argument0 = defaultArgument;
            }
            if (!argument1) {
              argument1 = defaultArgument;
            }
          }
          var code = argument0 + ' ' + operator + ' ' + argument1;
          return [code, order];
        };

        // Pin I/O blocks
        Blockly.Blocks['set_pin'] = {
          init: function() {
            this.appendValueInput("PIN")
                .setCheck("Number")
                .appendField("set pin");
            this.appendValueInput("VALUE")
                .setCheck("Boolean")
                .appendField("to");
            this.setPreviousStatement(true, null);
            this.setNextStatement(true, null);
            this.setColour(230);
            this.setTooltip("Set digital pin value");
          }
        };

        Blockly.JavaScript['set_pin'] = function(block) {
          var pin = Blockly.JavaScript.valueToCode(block, 'PIN', Blockly.JavaScript.ORDER_ATOMIC);
          var value = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
          return `digitalWrite(${pin}, ${value});\n`;
        };

        Blockly.Blocks['read_pin'] = {
          init: function() {
            this.appendValueInput("PIN")
                .setCheck("Number")
                .appendField("read pin");
            this.setOutput(true, "Boolean");
            this.setColour(230);
            this.setTooltip("Read digital pin value");
          }
        };

        Blockly.JavaScript['read_pin'] = function(block) {
          var pin = Blockly.JavaScript.valueToCode(block, 'PIN', Blockly.JavaScript.ORDER_ATOMIC);
          return [`digitalRead(${pin})`, Blockly.JavaScript.ORDER_FUNCTION_CALL];
        };

        // Motor blocks
        Blockly.Blocks['dc_motor'] = {
          init: function() {
            this.appendValueInput("SPEED")
                .setCheck("Number")
                .appendField("DC motor speed");
            this.setPreviousStatement(true, null);
            this.setNextStatement(true, null);
            this.setColour(20);
            this.setTooltip("Control DC motor speed");
          }
        };

        Blockly.JavaScript['dc_motor'] = function(block) {
          var speed = Blockly.JavaScript.valueToCode(block, 'SPEED', Blockly.JavaScript.ORDER_ATOMIC);
          return `motorSpeed(${speed});\n`;
        };

        Blockly.Blocks['servo_motor'] = {
          init: function() {
            this.appendValueInput("ANGLE")
                .setCheck("Number")
                .appendField("servo angle");
            this.setPreviousStatement(true, null);
            this.setNextStatement(true, null);
            this.setColour(20);
            this.setTooltip("Set servo motor angle");
          }
        };

        Blockly.JavaScript['servo_motor'] = function(block) {
          var angle = Blockly.JavaScript.valueToCode(block, 'ANGLE', Blockly.JavaScript.ORDER_ATOMIC);
          return `servoWrite(${angle});\n`;
        };

        // Sensor blocks
        Blockly.Blocks['ldr_sensor'] = {
          init: function() {
            this.appendDummyInput()
                .appendField("LDR sensor");
            this.setOutput(true, "Number");
            this.setColour(120);
            this.setTooltip("Read light sensor value");
          }
        };

        Blockly.JavaScript['ldr_sensor'] = function(block) {
          return ['analogRead(A0)', Blockly.JavaScript.ORDER_FUNCTION_CALL];
        };

        Blockly.Blocks['ir_sensor'] = {
          init: function() {
            this.appendDummyInput()
                .appendField("IR sensor");
            this.setOutput(true, "Boolean");
            this.setColour(120);
            this.setTooltip("Read IR sensor value");
          }
        };

        Blockly.JavaScript['ir_sensor'] = function(block) {
          return ['digitalRead(2)', Blockly.JavaScript.ORDER_FUNCTION_CALL];
        };

        Blockly.Blocks['temp_sensor'] = {
          init: function() {
            this.appendDummyInput()
                .appendField("temperature sensor");
            this.setOutput(true, "Number");
            this.setColour(120);
            this.setTooltip("Read temperature sensor value");
          }
        };

        Blockly.JavaScript['temp_sensor'] = function(block) {
          return ['readTemperature()', Blockly.JavaScript.ORDER_FUNCTION_CALL];
        };

        Blockly.Blocks['ultrasonic_sensor'] = {
          init: function() {
            this.appendDummyInput()
                .appendField("ultrasonic distance");
            this.setOutput(true, "Number");
            this.setColour(120);
            this.setTooltip("Read ultrasonic sensor distance");
          }
        };

        Blockly.JavaScript['ultrasonic_sensor'] = function(block) {
          return ['getDistance()', Blockly.JavaScript.ORDER_FUNCTION_CALL];
        };

        Blockly.Blocks['touch_sensor'] = {
          init: function() {
            this.appendDummyInput()
                .appendField("touch sensor");
            this.setOutput(true, "Boolean");
            this.setColour(120);
            this.setTooltip("Read touch sensor value");
          }
        };

        Blockly.JavaScript['touch_sensor'] = function(block) {
          return ['digitalRead(3)', Blockly.JavaScript.ORDER_FUNCTION_CALL];
        };

        Blockly.Blocks['color_sensor'] = {
          init: function() {
            this.appendDummyInput()
                .appendField("color sensor");
            this.setOutput(true, "String");
            this.setColour(120);
            this.setTooltip("Read color sensor value");
          }
        };

        Blockly.JavaScript['color_sensor'] = function(block) {
          return ['readColor()', Blockly.JavaScript.ORDER_FUNCTION_CALL];
        };

        // Joystick blocks
        Blockly.Blocks['joystick1'] = {
          init: function() {
            this.appendDummyInput()
                .appendField("joystick X");
            this.setOutput(true, "Number");
            this.setColour(290);
            this.setTooltip("Read joystick X value");
          }
        };

        Blockly.JavaScript['joystick1'] = function(block) {
          return ['analogRead(A1)', Blockly.JavaScript.ORDER_FUNCTION_CALL];
        };

        Blockly.Blocks['joystick2'] = {
          init: function() {
            this.appendDummyInput()
                .appendField("joystick Y");
            this.setOutput(true, "Number");
            this.setColour(290);
            this.setTooltip("Read joystick Y value");
          }
        };

        Blockly.JavaScript['joystick2'] = function(block) {
          return ['analogRead(A2)', Blockly.JavaScript.ORDER_FUNCTION_CALL];
        };

        // Define custom variable blocks to match the interface
        Blockly.Blocks['variables_declare'] = {
          init: function() {
            this.appendDummyInput()
                .appendField("Declare")
                .appendField(new Blockly.FieldVariable("i_count"), "VAR");
            this.setPreviousStatement(true, null);
            this.setNextStatement(true, null);
            this.setColour(290);
            this.setTooltip("Declare a variable");
            this.setHelpUrl("");
          }
        };

        Blockly.JavaScript['variables_declare'] = function(block) {
          var variable = Blockly.JavaScript.nameDB_.getName(block.getFieldValue('VAR'), Blockly.Variables.NAME_TYPE);
          return 'var ' + variable + ';\n';
        };

        Blockly.Blocks['variables_define'] = {
          init: function() {
            this.appendValueInput("VALUE")
                .setCheck(null)
                .appendField("Define")
                .appendField(new Blockly.FieldVariable("i_count"), "VAR")
                .appendField("to");
            this.setPreviousStatement(true, null);
            this.setNextStatement(true, null);
            this.setColour(290);
            this.setTooltip("Define a variable with initial value");
            this.setHelpUrl("");
          }
        };

        Blockly.JavaScript['variables_define'] = function(block) {
          var variable = Blockly.JavaScript.nameDB_.getName(block.getFieldValue('VAR'), Blockly.Variables.NAME_TYPE);
          var value = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ASSIGNMENT) || '0';
          return 'var ' + variable + ' = ' + value + ';\n';
        };
        Blockly.Blocks['oled_show'] = {
          init: function() {
            this.appendValueInput("TEXT")
                .setCheck("String")
                .appendField("OLED display");
            this.setPreviousStatement(true, null);
            this.setNextStatement(true, null);
            this.setColour(330);
            this.setTooltip("Display text on OLED screen");
          }
        };

        Blockly.JavaScript['oled_show'] = function(block) {
          var text = Blockly.JavaScript.valueToCode(block, 'TEXT', Blockly.JavaScript.ORDER_ATOMIC);
          return `oledDisplay(${text});\n`;
        };
      }

      // Initialize custom blocks
      defineCustomBlocks();

      fetch('navbar.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('navbar-placeholder').innerHTML = html;

          // Adjust #main-container height after navbar loads
          requestAnimationFrame(() => {
            const navbarHeight = document.getElementById('navbar-placeholder').offsetHeight || 0;
            const topbarHeight = document.getElementById('topbar').offsetHeight || 0;
            document.getElementById('main-container').style.height = `calc(100vh - ${navbarHeight + topbarHeight}px)`;
            Blockly.svgResize(workspace);
          });
        });

      workspace = Blockly.inject('blocklyDiv', {
        toolbox: document.getElementById('toolbox'),
        trashcan: true,
        scrollbars: true
      });

      // Create default variable
      workspace.createVariable('i_count');

      // Handle variable creation callback
      workspace.registerButtonCallback('CREATE_VARIABLE', function(button) {
        Blockly.Variables.createVariableButtonHandler(button.getTargetWorkspace());
      });

      window.addEventListener('resize', () => Blockly.svgResize(workspace));
      Blockly.svgResize(workspace);

      function sendCodeToMonaco(code, language = 'javascript') {
        const editorWindow = document.getElementById('monacoEditor').contentWindow;
        editorWindow.postMessage({ code, language }, '*');
      }

      function copyCode() {
        const iframe = document.querySelector('iframe');
        if (iframe && iframe.contentWindow) {
          const code = iframe.contentWindow.getEditorValue();
          navigator.clipboard.writeText(code).then(() => {
            // Restore focus to editor after copy
            setTimeout(() => {
              if (iframe.contentWindow.editor) {
                iframe.contentWindow.editor.focus();
              }
            }, 100);
          }).catch(err => {
            console.error('Failed to copy:', err);
          });
        }
      }

      function indent(code) {
        return code.split('\n').map(line => '  ' + line.trim()).join('\n');
      }

      function generateJavaScriptCode() {
        const code = Blockly.JavaScript.workspaceToCode(workspace);
        sendCodeToMonaco(code, 'javascript');
        setCurrentLanguage('javascript');
      }

      function generatePythonCode() {
        const code = Blockly.JavaScript.workspaceToCode(workspace)
          .replace(/console\.log/g, 'print')
          .replace(/;/g, '')
          .replace(/\b(var|let|const)\s+/g, '')
          .replace(/\bfunction\b/g, 'def')
          .replace(/\{/g, ':')
          .replace(/\}/g, '');
        sendCodeToMonaco(code, 'python');
        setCurrentLanguage('python');
      }

      function generateCppCode() {
        const raw = Blockly.JavaScript.workspaceToCode(workspace);
        const code = `
#include <Arduino.h>
void setup() {
  // Setup code
}
void loop() {
${indent(raw)}
}`;
        sendCodeToMonaco(code, 'cpp');
        setCurrentLanguage('cpp');
      }

      function generateCCode() {
        const raw = Blockly.JavaScript.workspaceToCode(workspace);
        const code = `
#include <stdio.h>
int main() {
${indent(raw)}
  return 0;
}`;
        sendCodeToMonaco(code, 'c');
        setCurrentLanguage('c');
      }

      function setCurrentLanguage(lang) {
        // This function is called but not implemented in original code
        // Adding empty implementation to prevent errors
      }

      function saveCode() {
        const xml = Blockly.Xml.workspaceToDom(workspace);
        const xmlText = Blockly.Xml.domToText(xml);
        const blob = new Blob([xmlText], { type: 'text/xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'blockly_program.xml';
        a.click();
        URL.revokeObjectURL(url);
      }

      function loadCode() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xml';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const xmlText = e.target.result;
                const xml = Blockly.Xml.textToDom(xmlText);
                workspace.clear();
                Blockly.Xml.domToWorkspace(xml, workspace);
              } catch (error) {
                alert('Error loading file: ' + error.message);
              }
            };
            reader.readAsText(file);
          }
        };
        input.click();
      }

      // Terminal functions
      function toggleTerminal() {
        const terminalPanel = document.getElementById('terminal-panel');
        const toggleBtn = document.getElementById('terminal-toggle');
        
        if (terminalVisible) {
          terminalPanel.style.display = 'none';
          toggleBtn.textContent = 'Show Terminal';
          terminalVisible = false;
        } else {
          terminalPanel.style.display = 'flex';
          toggleBtn.textContent = 'Hide Terminal';
          terminalVisible = true;
        }
        
        // Resize Blockly workspace
        setTimeout(() => Blockly.svgResize(workspace), 100);
      }

      function clearTerminal() {
        const terminalOutput = document.getElementById('terminal-output');
        if (terminalOutput) {
          terminalOutput.textContent = '';
        }
      }

      // Make functions globally available
      window.toggleTerminal = toggleTerminal;
      window.clearTerminal = clearTerminal;
      window.saveCode = saveCode;
      window.loadCode = loadCode;

      // Terminal resize functionality
      function setupTerminalResize() {
        const resizeHandle = document.getElementById('terminal-resize-handle');
        const terminalPanel = document.getElementById('terminal-panel');
        const mainContainer = document.getElementById('main-container');

        resizeHandle.addEventListener('mousedown', (e) => {
          isResizing = true;
          startY = e.clientY;
          startHeight = terminalPanel.offsetHeight;
          document.body.style.cursor = 'ns-resize';
          e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
          if (!isResizing) return;
          
          const deltaY = startY - e.clientY;
          const newHeight = Math.max(200, Math.min(50, startHeight + deltaY));
          terminalPanel.style.height = `${newHeight}px`;
        });

        document.addEventListener('mouseup', () => {
          if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            Blockly.svgResize(workspace);
          }
        });
      }

      // Initialize terminal resize
      document.addEventListener('DOMContentLoaded', () => {
        setupTerminalResize();
      });

      // Board connection status check
      const statusIndicator = document.getElementById('connection-status');
      document.getElementById('checkConnectionBtn').addEventListener('click', async () => {
        statusIndicator.style.backgroundColor = 'grey';
        const connected = await window.electronAPI?.checkBoard?.();
        statusIndicator.style.backgroundColor = connected ? 'green' : 'red';
      });
    </script>

    <script src="./renderer.js"></script>
  </body>
</html>